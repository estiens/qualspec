#!/usr/bin/env ruby
# frozen_string_literal: true

require 'qualspec'
require 'optparse'

options = {
  output: :stdout,
  progress: true,
  json_path: nil,
  html_path: nil,
  show_responses: false,
  record: nil,
  playback: nil
}

parser = OptionParser.new do |opts|
  opts.banner = 'Usage: qualspec [options] <eval_file.rb>'

  opts.on('-o', '--output FORMAT', %i[stdout json silent], 'Output format (stdout, json, silent)') do |format|
    options[:output] = format
  end

  opts.on('-j', '--json PATH', 'Write JSON results to PATH') do |path|
    options[:json_path] = path
  end

  opts.on('--html PATH', 'Write HTML report to PATH') do |path|
    options[:html_path] = path
  end

  opts.on('--no-progress', 'Disable progress output') do
    options[:progress] = false
  end

  opts.on('-r', '--responses', 'Show model responses in output') do
    options[:show_responses] = true
  end

  opts.on('--record NAME', 'Record API calls to cassette NAME') do |name|
    options[:record] = name
  end

  opts.on('--playback NAME', 'Playback API calls from cassette NAME') do |name|
    options[:playback] = name
  end

  opts.on('-m', '--model MODEL', 'Override judge model') do |model|
    Qualspec.configuration.judge_model = model
  end

  opts.on('-u', '--url URL', 'Override API URL') do |url|
    Qualspec.configuration.api_url = url
  end

  opts.on('-k', '--key KEY', 'Override API key') do |key|
    Qualspec.configuration.api_key = key
  end

  opts.on('-v', '--version', 'Show version') do
    puts "qualspec #{Qualspec::VERSION}"
    exit
  end

  opts.on('-h', '--help', 'Show this help') do
    puts opts
    puts
    puts 'Environment variables:'
    puts '  QUALSPEC_API_URL   API endpoint (default: http://localhost:11434/v1)'
    puts '  QUALSPEC_API_KEY   API key for authentication'
    puts '  QUALSPEC_MODEL     Default model for candidates'
    puts '  QUALSPEC_JUDGE_MODEL  Model to use as judge'
    puts
    puts 'Example:'
    puts '  qualspec eval/model_comparison.rb'
    puts '  qualspec -j results.json eval/model_comparison.rb'
    puts '  qualspec --html report.html eval/model_comparison.rb'
    puts '  QUALSPEC_API_URL=https://openrouter.ai/api/v1 qualspec eval/test.rb'
    exit
  end
end

parser.parse!

if ARGV.empty?
  puts parser
  exit 1
end

eval_file = ARGV.first

unless File.exist?(eval_file)
  warn "Error: File not found: #{eval_file}"
  exit 1
end

# Load builtins before the evaluation file
Qualspec::BuiltinRubrics.load!
Qualspec::Suite::BuiltinBehaviors.load!

# Load the evaluation file
load eval_file

# Find and run the suite
# The file should have defined exactly one suite
suites = Qualspec::Suite.registry.keys

if suites.empty?
  warn "Error: No evaluation suite defined in #{eval_file}"
  warn "Make sure your file calls Qualspec.evaluation 'Name' do ... end"
  exit 1
end

warn "Warning: Multiple suites defined, running first: #{suites.first}" if suites.size > 1

run_eval = lambda do
  Qualspec.run(
    suites.first,
    progress: options[:progress],
    output: options[:output],
    json_path: options[:json_path],
    html_path: options[:html_path],
    show_responses: options[:show_responses],
    load_builtins: false # Already loaded above
  )
end

begin
  if options[:record]
    Qualspec::Recorder.record(options[:record], &run_eval)
  elsif options[:playback]
    Qualspec::Recorder.playback(options[:playback], &run_eval)
  else
    run_eval.call
  end
rescue Qualspec::Error => e
  warn "Error: #{e.message}"
  exit 1
rescue Interrupt
  warn "\nInterrupted"
  exit 130
end
